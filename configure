#!/bin/sh

. scripts/configure.sh || exit 1

PACKAGE="cmus"
VERSION="1.6.8"
PACKAGE_BUGREPORT="tihirvon@gmail.com"

check_ncurses()
{
	if check_library ncurses "" -lncursesw
	then
		widechars=y
		return 0
	fi
	if check_library ncurses "" -lncurses || check_library ncurses "" -lcurses
	then
		widechars=n
		msg_error "Your ncurses does not support wide characters!"
		msg_error "Install ncursesw if you need wide character support,"
		msg_error "you can ignore this warning otherwise."
		return 0
	fi
	return 1
}

check_mpc()
{
	check_library MPC "" "-lmpcdec"
	return $?
}

check_flac()
{
	check_library FLAC "" "-lFLAC -lm"
	return $?
}

check_mad()
{
	pkg_check_modules mad "mad" "" "-lmad -lm"
	return $?
}

check_modplug()
{
	pkg_check_modules modplug "libmodplug" "-I/usr/include/libmodplug" "-lmodplug -lstdc++ -lm"
	return $?
}

check_vorbis()
{
	if test "$CONFIG_TREMOR" = y
	then
		pkg_check_modules vorbis "vobisidec" "" "-lvorbisidec -lm"
		return $?
	else
		pkg_check_modules vorbis "vorbisfile" "" "-lvorbisfile -lvorbis -lm -logg"
		return $?
	fi
}

flag_tremor()
{
	CONFIG_TREMOR=y
}

check_alsa()
{
	# the alsa.pc file should be always available
	pkg_check_modules alsa "alsa"
	return $?
}

check_arts()
{
	app_config arts artsc-config
	return $?
}

check_oss()
{
	case $(uname -s) in
		Linux|FreeBSD)
			;;
		*BSD)
			check_library OSS "" "-lossaudio"
			return $?
			;;
		*)
			# unknown
			;;
	esac

	OSS_CFLAGS=""
	OSS_LIBS=""
	msg_checking "for header <sys/soundcard.h>"
	if test -f /usr/include/sys/soundcard.h
	then
		msg_result "yes"
		makefile_vars OSS_CFLAGS OSS_LIBS
		return 0
	else
		msg_result "no"
	fi
	return 1
}

check_sun()
{
	msg_checking "for header <sys/audioio.h>"
	if test -f /usr/include/sys/audioio.h
	then
		msg_result "yes"
		return 0
	else
		msg_result "no"
		return 1
	fi
}

check_rst2html()
{
	for RST2HTML in rst2html.py rst2html
	do
		check_program $RST2HTML && break
	done
	# add these to config.mk even if the checks failed
	# because rst2html is not needed normally (doc is prebuilt)
	makefile_vars RST2HTML RST2HTML_FLAGS
	return 0
}

flag_dir()
{
	set_var $1 "$2"
}

flag_debug()
{
	# $1 = "debug"
	# $2 = arg (--debug=arg)
	case $2 in
		[0-2])
			DEBUG=$2
			;;
		*)
			die "argument for --debug must be 0-2"
			;;
	esac
}

flag_dev()
{
	# add these flags only if gcc supports them
	local extra="-Wdeclaration-after-statement"

	# has to be run in subshell
	( ${CC:-${CROSS}gcc} "$extra" -S -o /dev/null -x c /dev/null &> /dev/null ) || extra=""
	CFLAGS="-std=gnu99 -O2 -ggdb -Wall -Wshadow -Wredundant-decls -Wmissing-prototypes ${extra} -Werror -pipe"
	DEBUG=2
	prefix=$HOME
}

# defaults
prefix=/usr/local
bindir=""
datadir=""
libdir=""
DEBUG=1
CONFIG_TREMOR=n

add_flag prefix    y flag_dir   "Installation prefix [$prefix]" "=DIR"
add_flag bindir    y flag_dir   "User executables [PREFIX/bin]" "=DIR"
add_flag datadir   y flag_dir   "Read-only data [PREFIX/share]" "=DIR"
add_flag libdir    y flag_dir   "Libraries [PREFIX/lib]" "=DIR"

add_flag debug       y flag_debug  "Debugging level [$DEBUG]" "=[0-2]"
add_flag dev         n flag_dev    "This should be used only by developers"
add_flag with-tremor n flag_tremor "Use Tremor as Ogg/Vorbis input plugin"

add_check check_cc
add_check check_endianness
add_check check_dl
add_check check_pthread
add_check check_ncurses
add_check check_iconv
add_check check_rst2html

enable_flag flac    a CONFIG_FLAC    "FLAC (Free Lossless Audio Codec) support"
enable_flag mad     a CONFIG_MAD     "MPEG Audio Decoder (libmad) support"
enable_flag modplug a CONFIG_MODPLUG "libmodplug (mod, x3m, ...) support"
enable_flag mpc     a CONFIG_MPC     "MPC support"
enable_flag vorbis  a CONFIG_VORBIS  "Ogg/Vorbis support"
enable_flag wav     y CONFIG_WAV     "WAV support"
enable_flag alsa    a CONFIG_ALSA    "ALSA support"
enable_flag arts    a CONFIG_ARTS    "ARTS support"
enable_flag oss     a CONFIG_OSS     "Open Sound System support"
enable_flag sun     a CONFIG_SUN     "Sun Audio support"
enable_flag xdg     y CONFIG_XDG     "Use ~/.config/cmus/ instead of ~/.cmus/"

parse_command_line "$@"
run_checks

var_default bindir "${prefix}/bin"
var_default datadir "${prefix}/share"
var_default libdir "${prefix}/lib"

CFLAGS="${CFLAGS} -DDEBUG=$DEBUG"
test "$WORDS_BIGENDIAN" = y && CFLAGS="${CFLAGS} -DWORDS_BIGENDIAN"

DATADIR="$datadir"
LIBDIR="$libdir"

config_header_begin config.h
config_str PACKAGE VERSION PACKAGE_BUGREPORT DATADIR LIBDIR
config_bool CONFIG_TREMOR CONFIG_XDG
config_header_end

makefile_vars PACKAGE VERSION bindir datadir libdir
makefile_vars CONFIG_FLAC CONFIG_MAD CONFIG_MODPLUG CONFIG_MPC CONFIG_VORBIS CONFIG_WAV
makefile_vars CONFIG_ALSA CONFIG_ARTS CONFIG_OSS CONFIG_SUN

generate_config_mk

print_config

cat <<EOF
tremor:              ${CONFIG_TREMOR}
wide char support:   ${widechars}

Compiler Settings:
CC:                  ${CC}
LD:                  ${LD}
CFLAGS:              ${CFLAGS}
LDFLAGS:             ${LDFLAGS}
SOFLAGS:             ${SOFLAGS}

Installation Directories:
bindir:              ${bindir}
datadir:             ${datadir}
libdir:              ${libdir}
EOF
