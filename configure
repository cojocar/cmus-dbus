#!/bin/sh

. scripts/configure.sh || exit 1

PACKAGE="cmus"
VERSION="1.6.3"
PACKAGE_BUGREPORT="tihirvon@gmail.com"

check_ncurses()
{
	local libs=-lncursesw

	if check_lib "ncurses ($libs)" "$libs"
	then
		makefile_var NCURSES_CFLAGS ""
		makefile_var NCURSES_LIBS "$libs"
		return 0
	fi
	return 1
}

check_flac()
{
	if check_lib FLAC -lFLAC
	then
		makefile_var FLAC_CFLAGS ""
		makefile_var FLAC_LIBS -lFLAC
		return 0
	fi
	return 1
}

check_mad()
{
	local libs="-lmad -lm"

	if pkg_check_modules mad "mad"
	then
		return 0
	fi
	if check_lib "mad ($libs)" "$libs"
	then
		makefile_var MAD_CFLAGS ""
		makefile_var MAD_LIBS "$libs"
		return 0
	fi
	return 1
}

check_modplug()
{
	pkg_check_modules modplug "libmodplug"
	return $?
}

check_vorbis()
{
	pkg_check_modules vorbis "vorbisfile"
	return $?
}

check_alsa()
{
	pkg_check_modules alsa "alsa"
	return $?
}

check_arts()
{
	app_config arts artsc-config
	return $?
}

check_oss()
{
	msg_checking "for header /usr/include/sys/soundcard.h"
	if test -f /usr/include/sys/soundcard.h
	then
		msg_result "yes"
		return 0
	else
		msg_result "no"
		return 1
	fi
}

flag_dir()
{
	set_var $1 "$2"
}

flag_debug()
{
	# $1 = "debug"
	# $2 = arg (--debug=arg)
	case $2 in
		[0-2])
			DEBUG=$2
			;;
		*)
			die "argument for --debug must be 0-2"
			;;
	esac
}

flag_dev()
{
	CFLAGS="-std=gnu99 -O2 -ggdb -Wall -Wshadow -Wdeclaration-after-statement -Wredundant-decls -Wmissing-prototypes -Werror -pipe"
	DEBUG=2
	prefix=$HOME
}

# defaults
prefix=/usr/local
bindir=""
datadir=""
libdir=""
DEBUG=1

add_flag prefix    yes flag_dir   "Installation prefix [$prefix]" "=DIR"
add_flag bindir    yes flag_dir   "User executables [PREFIX/bin]" "=DIR"
add_flag datadir   yes flag_dir   "Read-only data [PREFIX/share]" "=DIR"
add_flag libdir    yes flag_dir   "Libraries [PREFIX/lib]" "=DIR"

add_flag debug     yes flag_debug "Debugging level [$DEBUG]" "=[0-2]"
add_flag dev       no  flag_dev   "This should be used only by developers"

add_check check_cc
add_check check_endianness
add_check check_dl
add_check check_pthread
add_check check_ncurses
add_check check_iconv

enable_use_config_h no

enable_flag flac    auto CONFIG_FLAC    "FLAC (Free Lossless Audio Codec) support"
enable_flag mad     auto CONFIG_MAD     "MPEG Audio Decoder (libmad) support"
enable_flag modplug auto CONFIG_MODPLUG "libmodplug (mod, x3m, ...) support"
enable_flag vorbis  auto CONFIG_VORBIS  "Ogg/Vorbis support"
enable_flag wav     yes  CONFIG_WAV     "WAV support"
enable_flag alsa    auto CONFIG_ALSA    "ALSA support"
enable_flag arts    auto CONFIG_ARTS    "ARTS support"
enable_flag oss     auto CONFIG_OSS     "Open Sound System support"

enable_use_config_h yes

enable_flag irman   no   CONFIG_IRMAN   "Irman support"

parse_command_line "$@"
run_checks

var_default bindir "${prefix}/bin"
var_default datadir "${prefix}/share"
var_default libdir "${prefix}/lib"

config_str PACKAGE $PACKAGE
config_str VERSION $VERSION
config_str PACKAGE_BUGREPORT "$PACKAGE_BUGREPORT"
config_str BINDIR "$bindir"
config_str DATADIR "$datadir"
config_str LIBDIR "$libdir"
makefile_env_vars bindir datadir libdir

CFLAGS="${CFLAGS} -DDEBUG=$DEBUG"
test "$WORDS_BIGENDIAN" -eq 1 && CFLAGS="${CFLAGS} -DWORDS_BIGENDIAN"

generate_config_h
generate_config_mk

sed -e "s:@VERSION@:${VERSION}:g" < "cmus.spec.in" > cmus.spec

print_config

cat <<EOF

Compiler Settings:
CC:                  ${CC}
LD:                  ${LD}
CFLAGS:              ${CFLAGS}
LDFLAGS:             ${LDFLAGS}
SOFLAGS:             ${SOFLAGS}

Installation Directories:
bindir:              ${bindir}
datadir:             ${datadir}
libdir:              ${libdir}
EOF
