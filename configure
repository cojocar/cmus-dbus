#!/bin/sh

. scripts/configure.sh || exit 1

PACKAGE="cmus"
VERSION="1.6.4"
PACKAGE_BUGREPORT="tihirvon@gmail.com"

check_ncurses()
{
	if check_library ncurses "" -lncursesw
	then
		widechars=yes
		return 0
	fi
	if check_library ncurses "" -lncurses || check_library ncurses "" -lcurses
	then
		widechars=no
		msg_error "Your ncurses does not support wide characters!"
		msg_error "Install ncursesw if you need wide character support,"
		msg_error "you can ignore this warning otherwise."
		return 0
	fi
	return 1
}

check_flac()
{
	check_library FLAC "" "-lFLAC -lm"
	return $?
}

check_mad()
{
	pkg_check_modules mad "mad" "" "-lmad -lm"
	return $?
}

check_modplug()
{
	pkg_check_modules modplug "libmodplug" "-I/usr/include/libmodplug" "-lmodplug -lstdc++ -lm"
	return $?
}

check_vorbis()
{
	pkg_check_modules vorbis "vorbisfile" "" "-lvorbisfile -lvorbis -lm -logg"
	return $?
}

check_alsa()
{
	# the alsa.pc file should be always available
	pkg_check_modules alsa "alsa"
	return $?
}

check_arts()
{
	app_config arts artsc-config
	return $?
}

check_oss()
{
	case $(uname -s) in
		Linux|FreeBSD)
			;;
		*BSD)
			check_library OSS "" "-lossaudio"
			return $?
			;;
		*)
			# unknown
			;;
	esac

	OSS_CFLAGS=""
	OSS_LIBS=""
	msg_checking "for header <sys/soundcard.h>"
	if test -f /usr/include/sys/soundcard.h
	then
		msg_result "yes"
		makefile_env_vars OSS_CFLAGS OSS_LIBS
		return 0
	else
		msg_result "no"
	fi
	return 1
}

check_sun()
{
	msg_checking "for header <sys/audioio.h>"
	if test -f /usr/include/sys/audioio.h
	then
		msg_result "yes"
		return 0
	else
		msg_result "no"
		return 1
	fi
}

flag_dir()
{
	set_var $1 "$2"
}

flag_debug()
{
	# $1 = "debug"
	# $2 = arg (--debug=arg)
	case $2 in
		[0-2])
			DEBUG=$2
			;;
		*)
			die "argument for --debug must be 0-2"
			;;
	esac
}

flag_dev()
{
	# add these flags only if gcc supports them
	local extra="-Wdeclaration-after-statement"

	# has to be run in subshell
	( ${CC:-${CROSS}gcc} "$extra" -S -o /dev/null -x c /dev/null &> /dev/null ) || extra=""
	CFLAGS="-std=gnu99 -O2 -ggdb -Wall -Wshadow -Wredundant-decls -Wmissing-prototypes ${extra} -Werror -pipe"
	DEBUG=2
	prefix=$HOME
}

# defaults
prefix=/usr/local
bindir=""
datadir=""
libdir=""
DEBUG=1

add_flag prefix    yes flag_dir   "Installation prefix [$prefix]" "=DIR"
add_flag bindir    yes flag_dir   "User executables [PREFIX/bin]" "=DIR"
add_flag datadir   yes flag_dir   "Read-only data [PREFIX/share]" "=DIR"
add_flag libdir    yes flag_dir   "Libraries [PREFIX/lib]" "=DIR"

add_flag debug     yes flag_debug "Debugging level [$DEBUG]" "=[0-2]"
add_flag dev       no  flag_dev   "This should be used only by developers"

add_check check_cc
add_check check_endianness
add_check check_dl
add_check check_pthread
add_check check_ncurses
add_check check_iconv

enable_use_config_h no

enable_flag flac    auto CONFIG_FLAC    "FLAC (Free Lossless Audio Codec) support"
enable_flag mad     auto CONFIG_MAD     "MPEG Audio Decoder (libmad) support"
enable_flag modplug auto CONFIG_MODPLUG "libmodplug (mod, x3m, ...) support"
enable_flag vorbis  auto CONFIG_VORBIS  "Ogg/Vorbis support"
enable_flag wav     yes  CONFIG_WAV     "WAV support"
enable_flag alsa    auto CONFIG_ALSA    "ALSA support"
enable_flag arts    auto CONFIG_ARTS    "ARTS support"
enable_flag oss     auto CONFIG_OSS     "Open Sound System support"
enable_flag sun     auto CONFIG_SUN     "Sun Audio support"

enable_use_config_h yes

enable_flag irman   no   CONFIG_IRMAN   "Irman support"

parse_command_line "$@"
run_checks

var_default bindir "${prefix}/bin"
var_default datadir "${prefix}/share"
var_default libdir "${prefix}/lib"

config_str PACKAGE $PACKAGE
config_str VERSION $VERSION
config_str PACKAGE_BUGREPORT "$PACKAGE_BUGREPORT"
config_str BINDIR "$bindir"
config_str DATADIR "$datadir"
config_str LIBDIR "$libdir"
makefile_env_vars bindir datadir libdir

CFLAGS="${CFLAGS} -DDEBUG=$DEBUG"
test "$WORDS_BIGENDIAN" -eq 1 && CFLAGS="${CFLAGS} -DWORDS_BIGENDIAN"

generate_config_h
generate_config_mk

sed -e "s:@VERSION@:${VERSION}:g" < "cmus.spec.in" > cmus.spec

print_config

cat <<EOF
wide char support:   ${widechars}

Compiler Settings:
CC:                  ${CC}
LD:                  ${LD}
CFLAGS:              ${CFLAGS}
LDFLAGS:             ${LDFLAGS}
SOFLAGS:             ${SOFLAGS}

Installation Directories:
bindir:              ${bindir}
datadir:             ${datadir}
libdir:              ${libdir}
EOF
